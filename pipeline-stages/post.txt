post {
    always {
        script {
            archiveArtifacts artifacts: 'trivy-reports/*.json', allowEmptyArchive: true
            archiveArtifacts artifacts: 'sonar-reports/*.json', allowEmptyArchive: true
            sendEmailWithAttachment(
                BUILD_STATUS: currentBuild.currentResult,
                BUILD_ID: env.BUILD_ID,
                BUILD_NUMBER: env.BUILD_NUMBER,
                BUILD_TRIGGER_USER: params.BUILD_TRIGGER_USER,
                COMMIT_ID: env.COMMIT_ID,
                BUILD_TIMESTAMP: new Date().format('yyyy-MM-dd HH:mm:ss'),
                RECIPIENT_EMAILS: env.EMAIL_RECIPIENTS,
                ATTACHMENTS_PATTERN: '*.zip',
                credentialsId: env.EMAIL_CREDENTIALS_ID,
                JOB_NAME: env.JOB_NAME
            )
            cleanupDockerImages(cleanupImages: env.CLEANUP_DOCKER_IMAGES)
            cleanWorkspace(excludePatterns: ['reports', 'logs'])
            cleanWs()
        }
    }
}